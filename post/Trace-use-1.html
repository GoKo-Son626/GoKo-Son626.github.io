<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Trace-structure - GoKo&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="GoKo&#039;s blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="GoKo&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="å¿«é€Ÿæ„å»º Trace å­ç³»ç»Ÿâ€œè®¤çŸ¥â€ 1"><meta property="og:type" content="blog"><meta property="og:title" content="GoKo"><meta property="og:url" content="https://goko-son626.github.io/"><meta property="og:site_name" content="GoKo"><meta property="og:description" content="å¿«é€Ÿæ„å»º Trace å­ç³»ç»Ÿâ€œè®¤çŸ¥â€ 1"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/avatar.png"><meta property="article:published_time" content="2025-05-16T10:37:48.000Z"><meta property="article:modified_time" content="2025-05-17T13:34:11.901Z"><meta property="article:author" content="GoKo Mell"><meta property="article:tag" content="Trace"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://goko-son626.github.io/post/Trace-use-1.html"},"headline":"GoKo's blog","image":["https://goko-son626.github.io/img/og_image.png"],"datePublished":"2025-05-16T10:37:48.000Z","dateModified":"2025-05-17T13:34:11.901Z","author":{"@type":"Person","name":"GoKo Mell"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject"}},"description":"å¿«é€Ÿæ„å»º Trace å­ç³»ç»Ÿâ€œè®¤çŸ¥â€ 1"}</script><link rel="canonical" href="https://goko-son626.github.io/post/Trace-use-1.html"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss.xml" title="GoKo's blog" type="application/rss+xml">
</head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/GoKo-Mell.png" alt="GoKo&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/friend">Friend</a></div><div class="navbar-end"><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus">Â </i>2025-05-16Â Â <a class="commentCountImg" href="/post/Trace-use-1.html#comment-container"><span class="display-none-class">3e396f3e46081490db90023b8e608c80</span><i class="far fa-comment-dots"></i>Â <span class="commentCount" id="3e396f3e46081490db90023b8e608c80">99+</span>Â Â </a><span class="level-item"><i class="far fa-clock">Â </i>27 åˆ†é’Ÿ Â <i class="fas fa-pencil-alt">Â </i>4.0Â k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>æ¬¡è®¿é—®</span></div></div><h1 class="title is-3 is-size-4-mobile">Trace-structure</h1><div class="content"><ul>
<li><em><strong>å¿«é€Ÿæ„å»º Trace å­ç³»ç»Ÿâ€œè®¤çŸ¥â€ 1</strong></em></li>
</ul>
<span id="more"></span>

<h1 id="Using-the-TRACE-EVENT-macroï¼ˆpart-1ï¼‰"><a href="#Using-the-TRACE-EVENT-macroï¼ˆpart-1ï¼‰" class="headerlink" title="Using the TRACE_EVENT() macroï¼ˆpart 1ï¼‰"></a>Using the <code>TRACE_EVENT()</code> macroï¼ˆpart 1ï¼‰</h1><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs txt">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚                          ğŸŒ  ç”¨æˆ·ç©ºé—´å·¥å…·å±‚                      â”‚<br>â”‚  strace*  trace-cmd  perf  bpftrace  bpftool  kernelshark  â€¦     â”‚<br>â”‚  Â· strace ä»…é  ptraceï¼Œä¸å…¥å†…æ ¸ Trace ä½“ç³»                       â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br>                â”‚ è°ƒç”¨ / å½•åˆ¶ / åŠ è½½<br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚                 ğŸ§©  ç»Ÿä¸€ Trace æ§åˆ¶æ¥å£ (tracefs)               â”‚<br>â”‚  /sys/kernel/debug/tracing/*   (ftraceÂ debugfs)                  â”‚<br>â”‚  tracefs APIs (kernel/trace/*.c)                                 â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br>                â”‚ è¯»å†™æ§åˆ¶æ–‡ä»¶æˆ– ioctl<br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚                ğŸ—  å†…æ ¸ Trace åŸºç¡€æ¡†æ¶ (TRACE SUBSYS)           â”‚<br>â”‚  â€¢ ftrace core  â€”â€” function/function_graph/irqsoff/â€¦            â”‚<br>â”‚  â€¢ trace events â€”â€” äº‹ä»¶æ³¨å†Œè¡¨ã€filtersã€ringâ€‘buffer             â”‚<br>â”‚  â€¢ hook dispatch â€”â€” æŠŠæ•°æ®å†™ ring buffer æˆ–è°ƒç”¨ eBPF            â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br>                â”‚ è°ƒç”¨ / é™„ç€<br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚                 ğŸ”§  ä½å±‚æ’æ¡©é’©å­ / Instrumentation ç‚¹           â”‚<br>â”‚  â”œâ”€ tracepoints  (ç”± TRACE_EVENT / DEFINE_EVENT ç”Ÿæˆ)           â”‚<br>â”‚  â”œâ”€ kprobes      (åŠ¨æ€æ’å†…æ ¸æŒ‡ä»¤)                                â”‚<br>â”‚  â”œâ”€ uprobes      (åŠ¨æ€æ’ç”¨æˆ·è¿›ç¨‹æŒ‡ä»¤)                            â”‚<br>â”‚  â””â”€ fentry/fexit (BPF_FENTRY, æ¯” kprobe æ›´è½»é‡çš„ BPF é’©å­)       â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br>                â”‚ attach<br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚                   âš™ï¸  eBPF æ‰§è¡Œå±‚ (BPF VM)                      â”‚<br>â”‚  â€¢ BPF ç¨‹åºå¯æŒ‚ tracepoints / kprobe / fentry / perf events      â”‚<br>â”‚  â€¢ è¿è¡Œåå¯æŠŠæ•°æ®å†™ perfâ€‘ringâ€‘buffer / maps â†’ ç”¨æˆ·ç©ºé—´           â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br></code></pre></td></tr></table></figure>

<p><strong>å…³é”®è¯´æ˜</strong></p>
<table>
<thead>
<tr>
<th>å±‚</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ç”¨æˆ·ç©ºé—´å·¥å…·å±‚</strong></td>
<td>è´Ÿè´£â€œæ§åˆ¶&#x2F;é‡‡é›†&#x2F;è§£æâ€ã€‚<code>trace-cmd</code>, <code>perf</code>, <code>bpftrace</code> éƒ½ç»ç”± tracefs æˆ– perf_event ç³»ç»Ÿè°ƒç”¨ä¸å†…æ ¸äº¤äº’ã€‚<code>strace</code> ä»…åŸºäº <code>ptrace()</code>ï¼Œå¹¶ä¸ä¾èµ–å†…æ ¸ Trace æ¡†æ¶ã€‚</td>
</tr>
<tr>
<td><strong>tracefsâ€¯æ§åˆ¶æ¥å£</strong></td>
<td><code>/sys/kernel/debug/tracing</code> æš´éœ²ä¸€å †æ–‡ä»¶ï¼Œå¦‚ <code>current_tracer</code>, <code>events/*/enable</code>, ä»»ä½•å·¥å…·éƒ½å¯ä»¥ç›´æ¥ echo æˆ– ioctlï¼›<code>trace-cmd</code> å°±æ˜¯æ‰¹é‡æ“ä½œè¿™äº›æ–‡ä»¶ã€‚</td>
</tr>
<tr>
<td><strong>å†…æ ¸ Trace åŸºç¡€æ¡†æ¶</strong></td>
<td>æŠŠ ftraceï¼ˆå‡½æ•°çº§ï¼‰ä¸ trace eventsï¼ˆäº‹ä»¶çº§ï¼‰ç»Ÿä¸€ï¼›å†³å®šå¦‚ä½•å†™ ring bufferã€å¦‚ä½•åšè¿‡æ»¤ï¼›åŒå±‚è¿˜åŒ…æ‹¬ irqsoffã€preemptoffã€wakeup ç­‰ç‰¹å®š tracerã€‚</td>
</tr>
<tr>
<td><strong>ä½å±‚æ’æ¡©é’©å­</strong></td>
<td>çœŸæ­£â€œè¢«å†…æ ¸ä»£ç è°ƒç”¨æˆ–æ‰“è¡¥ä¸â€çš„åœ°æ–¹ï¼š<br>â€¢ <strong>tracepoints</strong> &#x3D; é™æ€å® <code>TRACE_EVENT()</code> ç”Ÿæˆçš„å‡½æ•°ï¼›<br>â€¢ <strong>kprobe&#x2F;uprobe</strong> &#x3D; è¿è¡Œæ—¶åœ¨æŒ‡ä»¤å¤´æ’å…¥ <code>int3</code> ç­‰é™·é˜±ï¼›<br>â€¢ <strong>fentry&#x2F;fexit</strong> &#x3D; BPF ç›´æ¥åœ¨å‡½æ•° prologue&#x2F;epilogue é™„é’©ï¼›è¿™äº›é’©å­æŠŠé‡‡æ ·æ•°æ®äº¤ç»™ä¸Šä¸€å±‚æ¡†æ¶å¤„ç†ã€‚</td>
</tr>
<tr>
<td><strong>eBPF æ‰§è¡Œå±‚</strong></td>
<td>å±äºå†…æ ¸ï¼Œæ˜¯ä¸€ç§è¿è¡Œåœ¨å†…æ ¸é‡Œçš„â€œè™šæ‹Ÿæœºâ€ã€‚å®ƒä¸æ˜¯è¿›ç¨‹ï¼Œè€Œæ˜¯å†…æ ¸ä¸­çš„ç¨‹åºè¿è¡Œç¯å¢ƒï¼Œæ”¯æŒåŠ è½½ã€è¿è¡Œå°ç¨‹åºï¼ˆå­—èŠ‚ç ï¼‰ã€‚è¿™äº›å°ç¨‹åºç”±ç”¨æˆ·æ€å·¥å…·ç¼–è¯‘&#x2F;åŠ è½½ï¼Œæ¯”å¦‚ï¼šbpftrace -e â€˜tracepoint:syscalls:sys_enter_open { printf(â€œopen called\nâ€); }â€™      bpftool prog load prog.o &#x2F;sys&#x2F;fs&#x2F;bpf&#x2F;â€¦     è¿™äº›ç¨‹åºè¢«â€œåŠ è½½åˆ°å†…æ ¸å†…å­˜ä¸­ï¼Œå¹¶ç»‘å®šåˆ°æŸä¸ª hook ç‚¹ï¼ˆæ¯”å¦‚ tracepointï¼‰ä¸Šâ€ã€‚ä½†å¯åŠ è½½&#x2F;å¸è½½å­—èŠ‚ç ï¼›å¯ä»¥æŒ‚åˆ° tracepoint&#x2F;kprobe ç­‰ï¼›æ‰§è¡Œé€»è¾‘åæŠŠç»“æœå†™ ring buffer æˆ– BPF mapsï¼Œç”¨æˆ·ç©ºé—´å·¥å…·å†è¯»ã€‚    <strong>eBPF ç¨‹åºæ˜¯ç”¨æˆ·ç©ºé—´ç¼–è¯‘ â†’ ç³»ç»Ÿè°ƒç”¨ä¼ ç»™å†…æ ¸ â†’ verifier éªŒè¯ â†’ æŒ‚åˆ°é’©å­ç‚¹ â†’ è¿è¡Œ â†’ å¯ä»¥å¸è½½</strong></td>
</tr>
</tbody></table>
<p>å·¥å…·( trace-cmd &#x2F; perf &#x2F; bpftrace ) â†’<br>   æ“ä½œ tracefs æ¥å£ â†’<br>      é©±åŠ¨ ftrace + trace events æ¡†æ¶ â†’<br>         ä¾æ‰˜ tracepoint &#x2F; kprobe &#x2F; fentry ç­‰é’©å­æ”¶æ•° â†’<br>            (å¯é€‰) äº¤ç»™ eBPF åšå®æ—¶å¤„ç† â†’<br>               æ•°æ®è½åˆ° ring buffer â†’ å·¥å…·è§£ææ˜¾ç¤º</p>
<p>é’©å­å‡½æ•°æ˜¯ä¸€ç§æœºåˆ¶ï¼šæä¾›â€œæŒ‚é’©â€ä½ç½®ï¼Œå›è°ƒå‡½æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆä½ å†™çš„ï¼‰ï¼Œå‡½æ•°æŒ‚åˆ°é’©å­ä¸Šåé’©å­è¢«è§¦å‘å¯ä»¥è°ƒç”¨å‡½æ•°<br><strong>é’©å­å‡½æ•°</strong>ï¼šâ€œé’©å­å‡½æ•°â€æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§ ç‰¹å®šç”¨é€”çš„å›è°ƒå‡½æ•°ã€‚æˆ‘ä»¬åœ¨å†…æ ¸é‡Œç”¨â€œé’©å­â€è¿™ä¸ªè¯ï¼Œæ„æ€æ˜¯ï¼šâ€œæˆ‘åœ¨è¿™é‡Œç•™äº†ä¸€ä¸ªé’©å­ï¼ˆhook pointï¼‰ï¼Œä½ å¯ä»¥æŒ‚ä¸Šè‡ªå·±çš„å‡½æ•°ï¼Œå½“æŸä¸ªè¡Œä¸ºå‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚â€<br><strong>å›è°ƒå‡½æ•°</strong>ï¼šå›è°ƒå‡½æ•°å°±æ˜¯ä½ æå‰å®šä¹‰å¥½çš„å‡½æ•°æŒ‡é’ˆï¼Œç„¶ååœ¨æŸä¸ªæ—¶æœºç”±åˆ«äººï¼ˆç³»ç»Ÿã€åº“ã€æ¡†æ¶ï¼‰è°ƒç”¨å®ƒã€‚ä½ æŠŠ my_callback æ³¨å†Œè¿›å»ï¼›å½“â€œäº‹ä»¶â€è§¦å‘æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨ä½ çš„my_callbackã€‚<br>ex:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">my_callback</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;callback called with value = %d\n&quot;</span>, value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">trigger_event</span><span class="hljs-params">(<span class="hljs-type">void</span> (*cb)(<span class="hljs-type">int</span>))</span> &#123;<br>    cb(<span class="hljs-number">42</span>); <span class="hljs-comment">// åœ¨â€œäº‹ä»¶â€å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨ä½ çš„å›è°ƒå‡½æ•°</span><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    trigger_event(my_callback); <span class="hljs-comment">// æ³¨å†Œå›è°ƒ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>trace marker</code> æ˜¯ä¸€ç§æ—©æœŸçš„å†…æ ¸è·Ÿè¸ªæ‰‹æ®µï¼šç›´æ¥æŠŠ printf(â€œsome event happened: %dâ€, value); è¿™æ ·çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™è¿›äº†å†…æ ¸ä»£ç é‡Œï¼Œéå¸¸åƒæ˜¯â€œè°ƒè¯•ä¿¡æ¯â€ã€‚ä½†è¿™åšæ³•æ±¡æŸ“äº†ä»£ç ï¼Œçœ‹èµ·æ¥åƒæ˜¯ debug æ²¡åˆ å¹²å‡€ã€‚</p>
<p>åæ¥ Mathieu Desnoyers è®¾è®¡äº† tracepointsï¼Œåšæ³•æ˜¯ï¼š</p>
<ul>
<li>åœ¨å†…æ ¸çš„æŸäº›é€»è¾‘ç‚¹æ”¾ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæ¯”å¦‚ trace_my_event(foo, bar);</li>
<li>è¿™ä¸ªå‡½æ•°ä¸ä¼šç›´æ¥æ‰“å°ä»»ä½•ä¿¡æ¯ï¼Œè€Œæ˜¯ä¼šå»æŸ¥æœ‰æ²¡æœ‰äººæ³¨å†Œäº†å›è°ƒå‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯æŒ‚é’©å­ï¼‰ï¼›</li>
<li>å¦‚æœæœ‰äººæ³¨å†Œäº†ï¼Œå°±è°ƒç”¨æ³¨å†Œè€…çš„å›è°ƒå‡½æ•°ï¼ŒæŠŠå‚æ•° foo, bar ä¼ è¿›å»ã€‚<br>å°±åƒæˆ‘ä¸Šé¢ä¸¾çš„ trigger_event(cb) çš„ä¾‹å­ã€‚<br>è¿™æ ·åšæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š</li>
<li>å†…æ ¸ä»£ç æœ¬èº« ä¸å†å…³å¿ƒè°ƒè¯•æˆ–è·Ÿè¸ªé€»è¾‘ï¼Œåªç•™äº†ä¸ªé’©å­ç‚¹ï¼›</li>
<li>å›è°ƒå‡½æ•°å¯ä»¥æ¥æ”¶ç±»å‹æ˜ç¡®çš„ç»“æ„ä½“æŒ‡é’ˆï¼Œæ•ˆç‡æ›´é«˜ï¼Œä¸éœ€è¦å»è§£ææ ¼å¼åŒ–å­—ç¬¦ä¸²äº†ã€‚</li>
<li>ä½†æ˜¯é—®é¢˜æ˜¯ï¼šä½ æ¯æ¬¡æƒ³ä½¿ç”¨ tracepointï¼Œå°±è¦å†™ä¸€å † callback å‡½æ•°ï¼Œé‡å¤åˆç¹çã€‚</li>
</ul>
<p><strong>ä¸ºäº†è§£å†³â€œå†™å›è°ƒå¤ªéº»çƒ¦â€çš„é—®é¢˜ï¼šTRACE_EVENT() å®è¯ç”Ÿï¼š</strong><br>è¿™ä¸ªå®å¸®ä½ è‡ªåŠ¨ç”Ÿæˆï¼š<br>        - tracepoint çš„å®šä¹‰ï¼›<br>        - å¯¹åº”çš„ callback å‡½æ•°ï¼ˆé’©å­å‡½æ•°ï¼‰ï¼›<br>        - æ•°æ®æ ¼å¼åŒ–çš„é€»è¾‘ã€‚<br>ä½ åªéœ€è¦å†™ä¸€ä¸ªå®æè¿°ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">TRACE_EVENT(my_event,<br>    TP_PROTO(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b),<br>    TP_ARGS(a, b),<br>    TP_STRUCT__entry(<br>        __field(<span class="hljs-type">int</span>, a)<br>        __field(<span class="hljs-type">int</span>, b)<br>    ),<br>    TP_fast_assign(<br>        __entry-&gt;a = a;<br>        __entry-&gt;b = b;<br>    ),<br>    TP_printk(<span class="hljs-string">&quot;a=%d b=%d&quot;</span>, __entry-&gt;a, __entry-&gt;b)<br>);<br></code></pre></td></tr></table></figure>
<p>ç„¶åä¸€åˆ‡éƒ½è‡ªåŠ¨ç”Ÿæˆï¼ŒFtraceã€perfã€LTTngã€SystemTap éƒ½èƒ½ç”¨è¿™å¥—ç³»ç»Ÿæ¥è¿›è¡Œè·Ÿè¸ªã€‚<br>TRACE_EVENT()å®çš„å‰–æ<br><strong>è‡ªåŠ¨åŒ–è·Ÿè¸ªç‚¹æœ‰å„ç§å¿…é¡»æ»¡è¶³çš„è¦æ±‚ï¼š</strong></p>
<ul>
<li>å®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªå¯ä»¥æ”¾ç½®åœ¨å†…æ ¸ä»£ç ä¸­çš„è·Ÿè¸ªç‚¹ã€‚</li>
<li>å®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªå¯ä»¥æŒ‚æ¥åˆ°è¯¥è·Ÿè¸ªç‚¹çš„å›è°ƒå‡½æ•°ã€‚</li>
<li>å›è°ƒå‡½æ•°å¿…é¡»èƒ½å¤Ÿä»¥æœ€å¿«çš„æ–¹å¼å°†ä¼ é€’ç»™å®ƒçš„æ•°æ®è®°å½•åˆ°è·Ÿè¸ªå™¨ç¯å½¢ç¼“å†²åŒºä¸­ã€‚</li>
<li>å®ƒå¿…é¡»åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥è§£æè®°å½•åˆ°ç¯å½¢ç¼“å†²åŒºçš„æ•°æ®å¹¶å°†å…¶è½¬æ¢ä¸ºè·Ÿè¸ªå™¨å¯ä»¥æ˜¾ç¤ºç»™ç”¨æˆ·çš„äººç±»å¯è¯»çš„æ ¼å¼ã€‚<br><strong>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼ŒTRACE_EVENT()å®è¢«åˆ†è§£ä¸ºå…­ä¸ªéƒ¨åˆ†</strong>ï¼Œå®ƒä»¬ä¸å®çš„å‚æ•°ç›¸å¯¹åº”ï¼š<br>TRACE_EVENTï¼ˆåç§°ã€åè®®ã€å‚æ•°ã€ç»“æ„ã€åˆ†é…ã€æ‰“å°ï¼‰</li>
<li>nameâ€”â€”è¦åˆ›å»ºçš„è·Ÿè¸ªç‚¹çš„åç§°ã€‚</li>
<li>åŸå‹- è·Ÿè¸ªç‚¹å›è°ƒçš„åŸå‹</li>
<li>args - ä¸åŸå‹åŒ¹é…çš„å‚æ•°ã€‚</li>
<li>struct - è·Ÿè¸ªå™¨å¯ä»¥ä½¿ç”¨ï¼ˆä½†ä¸æ˜¯å¿…é¡»ï¼‰æ¥å­˜å‚¨ä¼ é€’åˆ°è·Ÿè¸ªç‚¹çš„æ•°æ®çš„ç»“æ„ã€‚</li>
<li>åˆ†é…â€”â€”ä»¥ç±»ä¼¼ C çš„æ–¹å¼å°†æ•°æ®åˆ†é…ç»™ç»“æ„ã€‚</li>
<li>print - ä»¥äººç±»å¯è¯»çš„ ASCII æ ¼å¼è¾“å‡ºç»“æ„çš„æ–¹å¼ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>Tracepoint åç§°</th>
<th>ç”¨é€”ç®€ä»‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>sched_switch</code></td>
<td>æ ¸å¿ƒ tracepointï¼Œä»»åŠ¡åˆ‡æ¢æ—¶è§¦å‘</td>
</tr>
<tr>
<td><code>sched_wakeup</code></td>
<td>æœ‰ä»»åŠ¡è¢«å”¤é†’ï¼ˆé€šå¸¸è¿›å…¥å¯è¿è¡Œé˜Ÿåˆ—ï¼‰æ—¶è§¦å‘</td>
</tr>
<tr>
<td><code>sched_wakeup_new</code></td>
<td>æ–°åˆ›å»ºä»»åŠ¡å”¤é†’æ—¶è§¦å‘ï¼ˆåŒºåˆ«äºå·²æœ‰ä»»åŠ¡ï¼‰</td>
</tr>
<tr>
<td><code>sched_migrate_task</code></td>
<td>ä»»åŠ¡åœ¨ CPU ä¹‹é—´è¿ç§»æ—¶è§¦å‘</td>
</tr>
<tr>
<td><code>sched_kthread_stop</code> &#x2F; <code>_ret</code></td>
<td>å†…æ ¸çº¿ç¨‹åœæ­¢ç›¸å…³</td>
</tr>
<tr>
<td><code>sched_kthread_work_*</code></td>
<td>å†…æ ¸çº¿ç¨‹ workqueue è°ƒåº¦è¿‡ç¨‹</td>
</tr>
<tr>
<td><code>sched_process_fork</code></td>
<td>åˆ›å»ºå­è¿›ç¨‹æ—¶è§¦å‘</td>
</tr>
<tr>
<td><code>sched_process_exec</code></td>
<td>exec è°ƒç”¨æ›¿æ¢ç¨‹åºæ˜ åƒæ—¶è§¦å‘</td>
</tr>
<tr>
<td><code>sched_process_exit</code></td>
<td>ä»»åŠ¡é€€å‡ºæ—¶è§¦å‘</td>
</tr>
</tbody></table>
<p><strong>æ ¸å¿ƒtracepoint</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Tracepoint for task switches, performed by the scheduler:</span><br><span class="hljs-comment"> */</span><br>TRACE_EVENT(sched_switch,<br><br>	TP_PROTO(<span class="hljs-type">bool</span> preempt,<br>		 <span class="hljs-keyword">struct</span> task_struct *prev,<br>		 <span class="hljs-keyword">struct</span> task_struct *next,<br>		 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> prev_state),<br><br>	TP_ARGS(preempt, prev, next, prev_state),<br><br>	TP_STRUCT__entry(<br>		__array(	<span class="hljs-type">char</span>,	prev_comm,	TASK_COMM_LEN	)<br>		__field(	<span class="hljs-type">pid_t</span>,	prev_pid			)<br>		__field(	<span class="hljs-type">int</span>,	prev_prio			)<br>		__field(	<span class="hljs-type">long</span>,	prev_state			)<br>		__array(	<span class="hljs-type">char</span>,	next_comm,	TASK_COMM_LEN	)<br>		__field(	<span class="hljs-type">pid_t</span>,	next_pid			)<br>		__field(	<span class="hljs-type">int</span>,	next_prio			)<br>	),<br><br>	TP_fast_assign(<br>		<span class="hljs-built_in">memcpy</span>(__entry-&gt;prev_comm, prev-&gt;comm, TASK_COMM_LEN);<br>		__entry-&gt;prev_pid	= prev-&gt;pid;<br>		__entry-&gt;prev_prio	= prev-&gt;prio;<br>		__entry-&gt;prev_state	= __trace_sched_switch_state(preempt, prev_state, prev);<br>		<span class="hljs-built_in">memcpy</span>(__entry-&gt;next_comm, next-&gt;comm, TASK_COMM_LEN);<br>		__entry-&gt;next_pid	= next-&gt;pid;<br>		__entry-&gt;next_prio	= next-&gt;prio;<br>		<span class="hljs-comment">/* XXX SCHED_DEADLINE */</span><br>	),<br><br>	TP_printk(<span class="hljs-string">&quot;prev_comm=%s prev_pid=%d prev_prio=%d prev_state=%s%s ==&gt; next_comm=%s next_pid=%d next_prio=%d&quot;</span>,<br>		__entry-&gt;prev_comm, __entry-&gt;prev_pid, __entry-&gt;prev_prio,<br><br>		(__entry-&gt;prev_state &amp; (TASK_REPORT_MAX - <span class="hljs-number">1</span>)) ?<br>		  __print_flags(__entry-&gt;prev_state &amp; (TASK_REPORT_MAX - <span class="hljs-number">1</span>), <span class="hljs-string">&quot;|&quot;</span>,<br>				&#123; TASK_INTERRUPTIBLE, <span class="hljs-string">&quot;S&quot;</span> &#125;,<br>				&#123; TASK_UNINTERRUPTIBLE, <span class="hljs-string">&quot;D&quot;</span> &#125;,<br>				&#123; __TASK_STOPPED, <span class="hljs-string">&quot;T&quot;</span> &#125;,<br>				&#123; __TASK_TRACED, <span class="hljs-string">&quot;t&quot;</span> &#125;,<br>				&#123; EXIT_DEAD, <span class="hljs-string">&quot;X&quot;</span> &#125;,<br>				&#123; EXIT_ZOMBIE, <span class="hljs-string">&quot;Z&quot;</span> &#125;,<br>				&#123; TASK_PARKED, <span class="hljs-string">&quot;P&quot;</span> &#125;,<br>				&#123; TASK_DEAD, <span class="hljs-string">&quot;I&quot;</span> &#125;) :<br>		  <span class="hljs-string">&quot;R&quot;</span>,<br><br>		__entry-&gt;prev_state &amp; TASK_REPORT_MAX ? <span class="hljs-string">&quot;+&quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>		__entry-&gt;next_comm, __entry-&gt;next_pid, __entry-&gt;next_prio)<br>);<br></code></pre></td></tr></table></figure>
<p>é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–ï¼Œæ‰€æœ‰å‚æ•°éƒ½å°è£…åœ¨å¦ä¸€ä¸ªå®ä¸­ï¼ˆTP_PROTOã€TP_ARGSã€TP_STRUCT__entryã€ TP_fast_assignå’ŒTP_printk ï¼‰ã€‚è¿™äº›å®åœ¨å¤„ç†è¿‡ç¨‹ä¸­æä¾›äº†æ›´å¤šæ§åˆ¶ï¼Œå¹¶ä¸”å…è®¸åœ¨TRACE_EVENT()å®ä¸­ä½¿ç”¨é€—å·ã€‚<br>ç¬¬<strong>ä¸€</strong>ä¸ªå‚æ•°æ˜¯åç§°:<br>ç¬¬<strong>äºŒ</strong>ä¸ªå‚æ•°æ˜¯åŸå‹: å®ƒæ—¢æ˜¯æ·»åŠ åˆ°å†…æ ¸ä»£ç çš„ tracepoint çš„åŸå‹ï¼Œä¹Ÿæ˜¯å›è°ƒå‡½æ•°çš„åŸå‹ã€‚tracepoint è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå°±åƒå›è°ƒå‡½æ•°åœ¨ tracepoint çš„ä½ç½®è¢«è°ƒç”¨ä¸€æ ·ã€‚<br>ç¬¬<strong>ä¸‰</strong>ä¸ªå‚æ•°æ˜¯åŸå‹ä½¿ç”¨çš„å‚æ•°:è¿™çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¥‡æ€ªï¼Œä½†è¿™ä¸ä»…æ˜¯TRACE_EVENT() å®æ‰€å¿…éœ€çš„ï¼Œä¹Ÿæ˜¯åº•å±‚ tracepoint åŸºç¡€æ¶æ„æ‰€å¿…éœ€çš„ã€‚tracepoint ä»£ç åœ¨æ¿€æ´»æ—¶ä¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼ˆä¸€ä¸ª tracepoint å¯èƒ½è¢«åˆ†é…å¤šä¸ªå›è°ƒå‡½æ•°ï¼‰ã€‚åˆ›å»º tracepoint çš„å®å¿…é¡»èƒ½å¤Ÿè®¿é—®åŸå‹å’Œå‚æ•°ã€‚ä¸‹é¢å±•ç¤ºäº† tracepoint å®å®ç°æ­¤ç›®çš„æ‰€éœ€çš„æ­¥éª¤ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> TRACE_POINT(name, proto, args) \</span><br><span class="hljs-meta">void trace_##name(proto)            \</span><br><span class="hljs-meta">&#123;                                   \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (trace_##name##_active)  \</span><br><span class="hljs-meta">                callback(args);     \</span><br><span class="hljs-meta">&#125;</span><br></code></pre></td></tr></table></figure>
<p>ç¬¬<strong>å››</strong>ä¸ªå‚æ•°æ˜¯ç»“æ„: è¿™ä¸ªç»“æ„ å†³å®šäº†æ¯æ¬¡ tracepoint è¢«è§¦å‘æ—¶è¦è®°å½•ä»€ä¹ˆå†…å®¹åˆ° trace bufferï¼ˆè·Ÿè¸ªç¼“å†²åŒºï¼‰ä¸­ã€‚å®šä¹‰ trace buffer ç»“æ„ä½“å­—æ®µ; <em>å°±æ˜¯å‘Šè¯‰å†…æ ¸ ring buffer è¦æœ‰å“ªå‡ ä¸ªå­—æ®µã€æ¯ä¸ªå­—æ®µå å¤šå¤§</em><br>ç¬¬<strong>äº”</strong>ä¸ªå‚æ•°æ˜¯ä»»åŠ¡: TP_fast_assign() çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°†äº‹ä»¶é‡‡æ ·æ—¶çš„æ•°æ®ï¼Œå†™å…¥åˆ° tracepoint å¯¹åº”çš„ç¯å½¢ç¼“å†²åŒºä¸­ï¼Œå…¶å¡«å……çš„å¯¹è±¡å°±æ˜¯ TP_STRUCT__entry ä¸­å®šä¹‰çš„ç»“æ„ä½“å­—æ®µã€‚ __entry æ˜¯æŒ‡å‘ TP_STRUCT__entry ä¸­å®šä¹‰ç»“æ„çš„æŒ‡é’ˆ<br>ç¬¬<strong>å…­</strong>ä¸ªå‚æ•°æ˜¯æ‰“å°: å®šä¹‰ ftrace &#x2F; trace-cmd &#x2F; perf ç­‰å·¥å…·åœ¨è¾“å‡º trace äº‹ä»¶æ—¶çš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œç›¸å½“äº printf æ ¼å¼ã€‚</p>
<p><strong>eBPF</strong>ï¼ˆExtended Berkeley Packet Filterï¼‰ æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€ä¸ªå¼ºå¤§æœºåˆ¶ï¼Œå®ƒå…è®¸ä½ åœ¨å†…æ ¸ç©ºé—´ä¸­å®‰å…¨ã€å—æ§åœ°è¿è¡Œå°ç¨‹åºï¼Œå®ç°è¯¸å¦‚ï¼š</p>
<ul>
<li>æ€§èƒ½åˆ†æï¼ˆæ¯”å¦‚æ›¿ä»£ perf å·¥å…·ï¼‰</li>
<li>ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªï¼ˆæ¯”å¦‚æ›¿ä»£ straceï¼‰</li>
<li>ç½‘ç»œåŒ…è¿‡æ»¤&#x2F;ç›‘æ§ï¼ˆæ›¿ä»£ iptables, tcpdump ç­‰ï¼‰</li>
<li>å®‰å…¨ç›‘æ§ã€æ²™ç®±</li>
</ul>
<p>å®ƒæœ€ç‰›çš„åœ°æ–¹åœ¨äºï¼š<br><strong>æ— éœ€æ”¹å†…æ ¸ä»£ç ã€æ— éœ€åŠ è½½å†…æ ¸æ¨¡å—ï¼Œå°±å¯ä»¥â€œåœ¨å†…æ ¸é‡Œè¿è¡Œä»£ç â€ã€‚</strong></p>
<p>eBPF ç¨‹åºï¼š</p>
<ul>
<li>æ˜¯å†™åœ¨ç”¨æˆ·ç©ºé—´çš„ç¨‹åºï¼ˆç”¨ C å†™ï¼Œæˆ–è€…ç”¨æ›´é«˜çº§è¯­è¨€ç”Ÿæˆï¼‰</li>
<li>ç¼–è¯‘æˆ eBPF å­—èŠ‚ç ï¼ˆåƒæ±‡ç¼–ä¸€æ ·ï¼‰</li>
<li>åŠ è½½åˆ°å†…æ ¸ä¸­</li>
<li>åœ¨æŸäº›é’©å­ç‚¹ï¼ˆæ¯”å¦‚ tracepointã€kprobeã€syscallï¼‰è¿è¡Œ</li>
</ul>
<p>eBPF å¯ä»¥æŒ‚è½½åˆ° tracepoint ä¸Šï¼š</p>
<ul>
<li>ç›‘å¬è°ƒåº¦å™¨è¡Œä¸ºï¼ˆæ¯”å¦‚å“ªä¸ªè¿›ç¨‹åˆ‡äº†è°ï¼‰</li>
<li>æ‹¿åˆ° sched_switch æä¾›çš„å„ç§æ•°æ®å­—æ®µï¼ˆprev_pid, next_pid, prev_state, â€¦ï¼‰</li>
<li>å†æŠŠè¿™äº›ä¿¡æ¯ç»Ÿè®¡ã€ä¸ŠæŠ¥ã€è¿‡æ»¤ã€å¯è§†åŒ–</li>
</ul>
<p>åœ¨ TP_STRUCT__entry(â€¦) ä¸­å®šä¹‰äº† tracepoint äº§ç”Ÿçš„æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">char</span> prev_comm[TASK_COMM_LEN];<br>  <span class="hljs-type">pid_t</span> prev_pid;<br>  <span class="hljs-type">int</span> prev_prio;<br>  <span class="hljs-type">long</span> prev_state;<br>  <span class="hljs-type">char</span> next_comm[TASK_COMM_LEN];<br>  <span class="hljs-type">pid_t</span> next_pid;<br>  <span class="hljs-type">int</span> next_prio;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>è¿™äº›å°±æ˜¯ eBPF ç¨‹åºâ€œèƒ½çœ‹åˆ°ã€èƒ½è¯»å–â€çš„å­—æ®µã€‚<br><strong>å› ä¸ºï¼š</strong></p>
<ul>
<li>å†…æ ¸ä¼šæŠŠè¿™äº›å­—æ®µä»¥ç»“æ„ä½“å½¢å¼å†™å…¥ ring bufferï¼ˆè·Ÿè¸ªç¼“å†²åŒºï¼‰</li>
<li>eBPF ç¨‹åºé™„åŠ ä¸Šå»ä¹‹åï¼Œä¼šè¢«ä¼ ä¸€ä¸ª ctxï¼ˆä¸Šä¸‹æ–‡æŒ‡é’ˆï¼‰</li>
<li>ç¨‹åºé€šè¿‡è¯»å– ctx ä¸­çš„å­—æ®µæ¥åšåˆ†æå¤„ç†</li>
</ul>
<p>strace æ˜¯ çº¯ç”¨æˆ·æ€çš„å·¥å…·ï¼Œå®ƒåŸºäº Linux æä¾›çš„ ptrace() ç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡ â€œæˆªè·è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨å…¥å£å’Œè¿”å›â€ å®ç°åŠŸèƒ½ã€‚å®ƒå¹¶ä¸çŸ¥é“ tracepoint çš„å­˜åœ¨ï¼Œä¹Ÿä¸ä½¿ç”¨å®ƒã€‚</p>
<p><strong>ä»€ä¹ˆå«â€œåŠ¨æ€æ³¨å…¥ eBPF æ‰€éœ€å­—æ®µå¸ƒå±€â€ï¼Ÿ</strong><br>æ„æ€å°±æ˜¯ï¼š</p>
<ul>
<li>ä½ ä¸éœ€è¦åœ¨å†™å†…æ ¸ä»£ç æ—¶å°±æŠŠ eBPF å†™è¿›å»</li>
<li>å†…æ ¸åªéœ€è¦åœ¨ tracepoint é‡Œç”¨ TRACE_EVENT æ­£ç¡®å®šä¹‰äº†å­—æ®µå¸ƒå±€</li>
<li>eBPF ç¨‹åºåœ¨è¿è¡Œæ—¶ attach åˆ°è¯¥ tracepointï¼Œå°±èƒ½åŠ¨æ€è¯»å–è¿™äº›å­—æ®µ</li>
<li>è¿™å°±æ˜¯â€œåŠ¨æ€æ³¨å…¥â€ï¼š<ul>
<li>ä¸æ”¹å†…æ ¸</li>
<li>ä¸é‡å¯ç³»ç»Ÿ</li>
<li>eBPF ç¨‹åºè¿è¡Œæ—¶ attach</li>
<li>æŒ‰ tracepoint ç»™å‡ºçš„å­—æ®µå¸ƒå±€è®¿é—®æ•°æ®</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>å†…å®¹</th>
<th>æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>TRACE_EVENT()</code></td>
<td>å®šä¹‰ä¸€ä¸ª tracepoint çš„ç»“æ„ä½“æ ¼å¼ã€æ‰“å°æ ¼å¼</td>
</tr>
<tr>
<td><code>/sys/kernel/debug/tracing/events/*/format</code></td>
<td>æè¿° tracepoint çš„å­—æ®µç»“æ„å’Œ printf æ ¼å¼ï¼Œä¾›å·¥å…·è§£æä½¿ç”¨</td>
</tr>
<tr>
<td><code>define_trace.h</code></td>
<td>æŠŠ <code>TRACE_EVENT</code> å®å±•å¼€ä¸ºå‡½æ•°å®šä¹‰ï¼Œå¿…é¡»æ”¾åœ¨ #endif å¤–é¢ã€‚</td>
</tr>
<tr>
<td><code>CREATE_TRACE_POINTS</code></td>
<td>å‘Šè¯‰ç¼–è¯‘å™¨åœ¨è¿™ä¸ª C æ–‡ä»¶ä¸­ç”Ÿæˆå‡½æ•°å®šä¹‰ï¼Œåªèƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶è¿™æ ·å†™</td>
</tr>
<tr>
<td>tracepoint çš„ä½¿ç”¨</td>
<td>åªéœ€è°ƒç”¨ <code>trace_xxx()</code> å‡½æ•°å°±èƒ½åœ¨å†…æ ¸ä¸­è®°å½•äº‹ä»¶</td>
</tr>
</tbody></table>
</div><div class="article-licensing box"><div class="licensing-title"><p>Trace-structure</p><p><a href="https://goko-son626.github.io/post/Trace-use-1.html">https://goko-son626.github.io/post/Trace-use-1.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>ä½œè€…</h6><a href="https://GoKo-Son626.github.io"><p>GoKo Mell</p></a></div></div><div class="level-item is-narrow"><div><h6>å‘å¸ƒäº</h6><p>2025-05-16</p></div></div><div class="level-item is-narrow"><div><h6>æ›´æ–°äº</h6><p>2025-05-17</p></div></div><div class="level-item is-narrow"><div><h6>è®¸å¯åè®®</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7">#Â ç›¸å…³æ–‡ç« </span><br><span>Â Â 1.<a class="is-size-6" href="/post/wds-IIC.html" target="_blank">IIC</a><br></span><span>Â Â 2.<a class="is-size-6" href="/post/riscv-toolchains.html" target="_blank">riscv-toolchains</a><br></span><span>Â Â 3.<a class="is-size-6" href="/post/Trace-do-chenxiaosong-1.html" target="_blank">Trace-do-chenxiaosong-1</a><br></span><span>Â Â 4.<a class="is-size-6" href="/post/Trace-use-2.html" target="_blank">Trace-use-2</a><br></span><span>Â Â 5.<a class="is-size-6" href="/post/qspinlock.html" target="_blank">qspinlock</a><br></span><span>Â Â 6.<a class="is-size-6" href="/post/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA.html" target="_blank">hexoåšå®¢æ­å»º</a><br></span><span>Â Â 7.<a class="is-size-6" href="/post/xv6-riscv-ch4.html" target="_blank">xv6-riscv_ch4</a><br></span><span>Â Â 8.<a class="is-size-6" href="/post/xv6-riscv-ch3.html" target="_blank">xv6-riscv_ch3</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Ÿæ‰“èµä¸€ä¸‹ä½œè€…å§</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>æ”¯ä»˜å®</span><span class="qrcode"><img src="/img/zfb.png" alt="æ”¯ä»˜å®"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>å¾®ä¿¡</span><span class="qrcode"><img src="/img/vx.png" alt="å¾®ä¿¡"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/Trace-use-2.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Trace-use-2</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/qspinlock.html"><span class="level-item">qspinlock</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">è¯„è®º</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '3e396f3e46081490db90023b8e608c80',
            repo: 'blog_comment',
            owner: 'GoKo-Son626',
            clientID: 'Ov23liQkUSIVMH77fBvF',
            clientSecret: '7944864208d7577569d1f323e727967d4bdc5e79',
            admin: ["Goko-Son626"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/logo.png" alt="GoKo Mell"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">GoKo Mell</p><p class="is-size-6 is-block">å°šæœªæ‰§ä½©å‰‘ï¼Œè½¬çœ¼å³æ±Ÿæ¹–</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>ä¸­å›½</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ–‡ç« </p><a href="/archives/"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">åˆ†ç±»</p><a href="/categories/"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">æ ‡ç­¾</p><a href="/tags/"><p class="title">6</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/GoKo-Son626" target="_blank" rel="noopener">å…³æ³¨æˆ‘</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/GoKo-Son626"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:goku.sonxin626@gmail.com"><i class="fa fa-envelope"></i></a></div><div><hr><p id="hitokoto">:D ä¸€è¨€å¥å­è·å–ä¸­...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"æ¥æºã€Š"+data.from+"ã€‹</p><p>æä¾›è€…-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">é“¾æ¥</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">æœ€æ–°æ–‡ç« </h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-25T02:02:38.000Z">2025-05-25</time></p><p class="title"><a href="/post/wds-IIC.html">IIC</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-18T08:30:56.000Z">2025-05-18</time></p><p class="title"><a href="/post/riscv-toolchains.html">riscv-toolchains</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-17T08:26:57.000Z">2025-05-17</time></p><p class="title"><a href="/post/Trace-do-chenxiaosong-1.html">Trace-do-chenxiaosong-1</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-17T02:27:26.000Z">2025-05-17</time></p><p class="title"><a href="/post/Trace-use-2.html">Trace-use-2</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-05-16T10:37:48.000Z">2025-05-16</time></p><p class="title"><a href="/post/Trace-use-1.html">Trace-structure</a></p></div></article></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">å½’æ¡£</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/05/"><span class="level-start"><span class="level-item">äº”æœˆ 2025</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/02/"><span class="level-start"><span class="level-item">äºŒæœˆ 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">æ ‡ç­¾</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/xv6-riscv/"><span class="tag">xv6-riscv</span><span class="tag is-grey-lightest">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Trace/"><span class="tag">Trace</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux-dirvers/"><span class="tag">linux-dirvers</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/riscv/"><span class="tag">riscv</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/riscv-toolchain/"><span class="tag">riscv-toolchain</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/GoKo-Mell.png" alt="GoKo&#039;s blog" height="28"></a><p class="size-small"><span>&copy; 2025 GoKo Mell</span>Â Â Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a>Â <br><span>Â© ç‰ˆæƒè¯´æ˜ï¼š[æœ¬ç½‘ç«™æ‰€æœ‰å†…å®¹å‡æ”¶é›†äºäº’è”ç½‘æˆ–è‡ªå·±åˆ›ä½œ,<br />&nbsp;&nbsp;&nbsp;&nbsp;æ–¹ä¾¿äºç½‘å‹ä¸è‡ªå·±å­¦ä¹ äº¤æµï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·<a href="mailto:goku.sonxin626@gmail.com">è”ç³»æˆ‘</a>ï¼Œç«‹å³å¤„ç†]<br /></span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('Ov23liQkUSIVMH77fBvF','7944864208d7577569d1f323e727967d4bdc5e79','GoKo-Son626','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>