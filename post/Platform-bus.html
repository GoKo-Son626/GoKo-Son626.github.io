<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>平台总线的结构及框架分析 - GoKo&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="GoKo&#039;s blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="GoKo&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="平台总线是linux系统虚拟出来的一种总线,是一个内核子系统，负责管理 platform_device（硬件描述）和 platform_driver（驱动代码）,使它们先分离.后搭档"><meta property="og:type" content="blog"><meta property="og:title" content="GoKo"><meta property="og:url" content="https://goko-son626.github.io/"><meta property="og:site_name" content="GoKo"><meta property="og:description" content="平台总线是linux系统虚拟出来的一种总线,是一个内核子系统，负责管理 platform_device（硬件描述）和 platform_driver（驱动代码）,使它们先分离.后搭档"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/avatar.png"><meta property="article:published_time" content="2024-06-07T03:33:21.000Z"><meta property="article:modified_time" content="2025-09-11T08:30:36.076Z"><meta property="article:author" content="GoKo Mell"><meta property="article:tag" content="platform_bus"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/avatar.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://goko-son626.github.io/post/Platform-bus.html"},"headline":"GoKo's blog","image":["https://goko-son626.github.io/img/og_image.png"],"datePublished":"2024-06-07T03:33:21.000Z","dateModified":"2025-09-11T08:30:36.076Z","author":{"@type":"Person","name":"GoKo Mell"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject"}},"description":"平台总线是linux系统虚拟出来的一种总线,是一个内核子系统，负责管理 platform_device（硬件描述）和 platform_driver（驱动代码）,使它们先分离.后搭档"}</script><link rel="canonical" href="https://goko-son626.github.io/post/Platform-bus.html"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdnjs.loli.net/ajax/libs/pace/1.2.4/pace.min.js"></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss.xml" title="GoKo's blog" type="application/rss+xml">
</head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/GoKo-Mell.png" alt="GoKo&#039;s blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/friend">Friend</a></div><div class="navbar-end"><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2024-06-07  <a class="commentCountImg" href="/post/Platform-bus.html#comment-container"><span class="display-none-class">179c676dd225a2fb62138ab93888e379</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="179c676dd225a2fb62138ab93888e379">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>31 分钟  <i class="fas fa-pencil-alt"> </i>4.7 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">平台总线的结构及框架分析</h1><div class="content"><ul>
<li><em><strong>平台总线是linux系统虚拟出来的一种总线,是一个内核子系统，负责管理 platform_device（硬件描述）和 platform_driver（驱动代码）,使它们先分离.后搭档</strong></em></li>
</ul>
<span id="more"></span>

<h3 id="平台总线-Platform-Bus-总线控制器信息和控制器驱动之间"><a href="#平台总线-Platform-Bus-总线控制器信息和控制器驱动之间" class="headerlink" title="平台总线(Platform Bus)(总线控制器信息和控制器驱动之间)"></a>平台总线(Platform Bus)(总线控制器信息和控制器驱动之间)</h3><ul>
<li>平台总线（Platform Bus）是内核的一条“虚拟”总线。它不像 PCI、USB 那样是物理上存在的总线，而是为了解决一类特殊设备的驱动问题而设计的 <strong>软件机制</strong>。这类设备通常是 <strong>SoC (System on Chip) 芯片内部集成的、不可被自动识别的外设</strong>，比如 I2C 控制器、SPI 控制器、GPIO 控制器、LCD 控制器等。</li>
</ul>
<ul>
<li><strong>原理：设备与驱动的分离与匹配 (Separation and Matching)</strong><ul>
<li><p><strong>问题：</strong> 对于 PCI 或 USB 设备，设备自身带有 ID 信息（Vendor ID, Product ID）。驱动可以根据这些 ID “认领” 设备。但 SoC 上的那些外设，它们的寄存器地址、中断号都是固定的，写死在芯片里了，没法自动发现。</p>
</li>
<li><p><strong>解决：</strong> 把 <strong>设备信息</strong> 和 <strong>驱动代码</strong> 分开！”</p>
<ol>
<li><strong>平台设备 (<code>platform_device</code>)：</strong> 这是一块纯粹的“数据”，用来描述硬件资源。它告诉内核：“在物理地址 <code>0x12345678</code> 有个设备，它使用中断号 <code>5</code>，它的名字叫 <code>my-i2c-controller</code>”。这些信息通常写在 <strong>设备树 (Device Tree, <code>.dts</code> 文件)</strong> 中，或者早期的板级配置文件 (<code>board-xxx.c</code>)里。</li>
<li><strong>平台驱动 (<code>platform_driver</code>)：</strong> 真正的驱动代码。注册时告诉内核：是一个驱动，我能处理名字叫 <code>my-i2c-controller</code> 的设备。</li>
<li><strong>匹配 (<code>Match</code>)：</strong> 当一个 <code>platform_device</code> 和一个 <code>platform_driver</code> 被注册到内核时，平台总线核心会进行匹配。最常见的匹配方式就是看 <strong>名字</strong> 是否一样。</li>
<li><strong>探测 (<code>Probe</code>)：</strong> 一旦匹配成功，总线核心就会调用平台驱动的 <code>.probe</code> 函数。在这个函数里，驱动程序会通过相关的API函数从 <code>platform_device</code> 结构体中获取到设备的硬件资源（如内存地址、中断号），然后用这些信息去初始化硬件，完成驱动的加载。</li>
</ol>
</li>
<li><p><strong>流程：</strong></p>
<ul>
<li>系统启动，内核解析设备树。</li>
<li>内核在设备树里读到一段描述 I2C 控制器硬件的节点（包含了寄存器地址、中断号，以及最重要的 compatible &#x3D; “vendor,i2c-controller-v1”;）。</li>
<li>内核根据这个节点，创建并注册一个 platform_device 到平台总线。</li>
<li>I2C 控制器驱动（platform_driver）在加载时，会告诉平台总线：“我能处理 compatible 是 “vendor,i2c-controller-v1” 的设备”。</li>
<li>平台总线看到两者匹配，于是调用 I2C 控制器驱动的 .probe 函数。<ul>
<li>在 I2C 控制器驱动的 .probe 函数中，驱动程序会执行一系列初始化操作，其中最重要的一步是调用 i2c_add_adapter() 或 i2c_add_numbered_adapter()。这个函数调用，才是在内核中“建立”或“注册”了一条 I2C 总线（即一个 i2c_adapter）。这条逻辑上的总线就代表了那条物理的 I2C 总线。内核里的 i2c_adapter 就是物理 I2C 总线在软件层面的抽象。</li>
</ul>
</li>
<li><strong>设备间交互</strong>：<ul>
<li>“其他设备驱动”（比如 I2C 温度传感器驱动）不直接调用 I2C 控制器驱动里的 ops。这是一个分层概念。</li>
<li>正确的交互方式：<ul>
<li>I2C 控制器驱动把它实现底层 I&#x2F;O 操作的 ops（struct i2c_algorithm）注册给了 I2C 总线核心。</li>
<li>I2C 温度传感器驱动想通信时，它调用的是 I2C 总线核心提供的标准、统一的 API，如 i2c_master_send() 和 i2c_master_recv()。</li>
<li>I2C 总线核心在收到这些 API 调用后，会找到对应的 i2c_adapter，然后去调用这个 adapter 在注册时提供的 ops 里的具体函数，最终由 I2C 控制器驱动的代码来操作硬件。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="platform-bus-设备和驱动"><a href="#platform-bus-设备和驱动" class="headerlink" title="platform bus 设备和驱动"></a>platform bus 设备和驱动</h3><h4 id="1-platform-device结构体"><a href="#1-platform-device结构体" class="headerlink" title="1. platform_device结构体"></a>1. platform_device结构体</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device</span> &#123;</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span>	*name;  <span class="hljs-comment">// 显示在/sys/bus/platform/devices/name.id(.auto)</span><br>  <span class="hljs-type">int</span>		id;           <span class="hljs-comment">// 用来区分不同设备：name.id, id = -1: 没有后缀</span><br>  <span class="hljs-type">bool</span>		id_auto;    <span class="hljs-comment">// 自动设置id：name.id.auto</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span>	<span class="hljs-title">dev</span>;</span>  <span class="hljs-comment">// 设备的通用属性部分</span><br>  u64		platform_dma_mask;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_dma_parameters</span> <span class="hljs-title">dma_parms</span>;</span><br>  u32		num_resources;        <span class="hljs-comment">// 存储的资源的个数</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">resource</span>	*<span class="hljs-title">resource</span>;</span>  <span class="hljs-comment">// 存储资源</span><br><br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device_id</span>	*<span class="hljs-title">id_entry</span>;</span><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * Driver name to force a match.  Do not set directly, because core</span><br><span class="hljs-comment">   * frees it.  Use driver_set_override() to set or clear it.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *driver_override;<br><br>  <span class="hljs-comment">/* MFD cell pointer */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mfd_cell</span> *<span class="hljs-title">mfd_cell</span>;</span><br><br>  <span class="hljs-comment">/* arch specific additions */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pdev_archdata</span>	<span class="hljs-title">archdata</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p><strong>成员结构体:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kobject</span> <span class="hljs-title">kobj</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span>		*<span class="hljs-title">parent</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_private</span>	*<span class="hljs-title">p</span>;</span><br><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span>		*init_name; <span class="hljs-comment">/* initial name of the device */</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_type</span> *<span class="hljs-title">type</span>;</span><br><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus_type</span>	*<span class="hljs-title">bus</span>;</span>	<span class="hljs-comment">/* type of bus device is on */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_driver</span> *<span class="hljs-title">driver</span>;</span>	<span class="hljs-comment">/* which driver has allocated this</span><br><span class="hljs-comment">					   device */</span><br>	<span class="hljs-type">void</span>		*platform_data;	<span class="hljs-comment">/* Platform specific data, device</span><br><span class="hljs-comment">					   core doesn&#x27;t touch it */</span><br>	<span class="hljs-type">void</span>		*driver_data;	<span class="hljs-comment">/* Driver data, set and get with</span><br><span class="hljs-comment">					   dev_set_drvdata/dev_get_drvdata */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span>		<span class="hljs-title">mutex</span>;</span>	<span class="hljs-comment">/* mutex to synchronize calls to</span><br><span class="hljs-comment">					 * its driver.</span><br><span class="hljs-comment">					 */</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_links_info</span>	<span class="hljs-title">links</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_pm_info</span>	<span class="hljs-title">power</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_pm_domain</span>	*<span class="hljs-title">pm_domain</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ENERGY_MODEL</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">em_perf_domain</span>	*<span class="hljs-title">em_pd</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PINCTRL</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_pin_info</span>	*<span class="hljs-title">pins</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_msi_info</span>	<span class="hljs-title">msi</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ARCH_HAS_DMA_OPS</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_map_ops</span> *<span class="hljs-title">dma_ops</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	u64		*dma_mask;	<span class="hljs-comment">/* dma mask (if dma&#x27;able device) */</span><br>	u64		coherent_dma_mask;<span class="hljs-comment">/* Like dma_mask, but for</span><br><span class="hljs-comment">					     alloc_coherent mappings as</span><br><span class="hljs-comment">					     not all hardware supports</span><br><span class="hljs-comment">					     64 bit addresses for consistent</span><br><span class="hljs-comment">					     allocations such descriptors. */</span><br>	u64		bus_dma_limit;	<span class="hljs-comment">/* upstream dma constraint */</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus_dma_region</span> *<span class="hljs-title">dma_range_map</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_dma_parameters</span> *<span class="hljs-title">dma_parms</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>	<span class="hljs-title">dma_pools</span>;</span>	<span class="hljs-comment">/* dma pools (if dma&#x27;ble) */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DMA_DECLARE_COHERENT</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_coherent_mem</span>	*<span class="hljs-title">dma_mem</span>;</span> <span class="hljs-comment">/* internal for coherent mem</span><br><span class="hljs-comment">					     override */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DMA_CMA</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cma</span> *<span class="hljs-title">cma_area</span>;</span>		<span class="hljs-comment">/* contiguous memory area for dma</span><br><span class="hljs-comment">					   allocations */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SWIOTLB</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_tlb_mem</span> *<span class="hljs-title">dma_io_tlb_mem</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SWIOTLB_DYNAMIC</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">dma_io_tlb_pools</span>;</span><br>	<span class="hljs-type">spinlock_t</span> dma_io_tlb_lock;<br>	<span class="hljs-type">bool</span> dma_uses_io_tlb;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-comment">/* arch specific additions */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_archdata</span>	<span class="hljs-title">archdata</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_node</span>	*<span class="hljs-title">of_node</span>;</span> <span class="hljs-comment">/* associated device tree node */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fwnode_handle</span>	*<span class="hljs-title">fwnode</span>;</span> <span class="hljs-comment">/* firmware device node */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_NUMA</span><br>	<span class="hljs-type">int</span>		numa_node;	<span class="hljs-comment">/* NUMA node this device is close to */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-type">dev_t</span>			devt;	<span class="hljs-comment">/* dev_t, creates the sysfs &quot;dev&quot; */</span><br>	u32			id;	<span class="hljs-comment">/* device instance */</span><br><br>	<span class="hljs-type">spinlock_t</span>		devres_lock;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>	<span class="hljs-title">devres_head</span>;</span><br><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-keyword">class</span>	*<span class="hljs-keyword">class</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">attribute_group</span> **<span class="hljs-title">groups</span>;</span>	<span class="hljs-comment">/* optional groups */</span><br><br>	<span class="hljs-type">void</span>	(*release)(<span class="hljs-keyword">struct</span> device *dev);      <span class="hljs-comment">// 必须编写，不然驱动编译不过去</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iommu_group</span>	*<span class="hljs-title">iommu_group</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_iommu</span>	*<span class="hljs-title">iommu</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_physical_location</span> *<span class="hljs-title">physical_location</span>;</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">device_removable</span>	<span class="hljs-title">removable</span>;</span><br><br>	<span class="hljs-type">bool</span>			offline_disabled:<span class="hljs-number">1</span>;<br>	<span class="hljs-type">bool</span>			offline:<span class="hljs-number">1</span>;<br>	<span class="hljs-type">bool</span>			of_node_reused:<span class="hljs-number">1</span>;<br>	<span class="hljs-type">bool</span>			state_synced:<span class="hljs-number">1</span>;<br>	<span class="hljs-type">bool</span>			can_match:<span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_DEVICE) || \</span><br><span class="hljs-meta">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU) || \</span><br><span class="hljs-meta">    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU_ALL)</span><br>	<span class="hljs-type">bool</span>			dma_coherent:<span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DMA_OPS_BYPASS</span><br>	<span class="hljs-type">bool</span>			dma_ops_bypass : <span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DMA_NEED_SYNC</span><br>	<span class="hljs-type">bool</span>			dma_skip_sync:<span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_IOMMU_DMA</span><br>	<span class="hljs-type">bool</span>			dma_iommu:<span class="hljs-number">1</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Resources are tree-like, allowing</span><br><span class="hljs-comment"> * nesting etc..</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">resource</span> &#123;</span><br>	<span class="hljs-type">resource_size_t</span> start;  <span class="hljs-comment">// 资源的起始信息和终止信息</span><br>	<span class="hljs-type">resource_size_t</span> end;    <span class="hljs-comment">// etc：中断的起始地址和终止地址</span><br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;       <span class="hljs-comment">// 存储信息名称：etc：中断-irq</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;    <span class="hljs-comment">// 存储资源类型：etc: IORESOURCE_IO/MEM/REG/IRQ/DMA/BUS...</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> desc;     <span class="hljs-comment">// 描述信息</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">resource</span> *<span class="hljs-title">parent</span>, *<span class="hljs-title">sibling</span>, *<span class="hljs-title">child</span>;</span> <span class="hljs-comment">// 节点相关</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="2-简单的platform-device"><a href="#2-简单的platform-device" class="headerlink" title="2. 简单的platform_device"></a>2. 简单的platform_device</h4><ul>
<li>insmod注册成功：ls &#x2F;sys&#x2F;bus&#x2F;platform&#x2F;devices&#x2F;mydevice</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/platform_device.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">resource</span> <span class="hljs-title">mydevice_resource</span>[] =</span> &#123;<br>  [<span class="hljs-number">0</span>] = &#123;<br>    .start = <span class="hljs-number">0xFDD60000</span>,<br>    .end = <span class="hljs-number">0xFDD50004</span>,<br>    .flags = IORESOURCE_IO,<br>  &#125;,<br>  [<span class="hljs-number">1</span>] = &#123;<br>    .start = <span class="hljs-number">13</span>,<br>    .end = <span class="hljs-number">13</span>,<br>    .flags = IORESOURCE_IRQ,<br>  &#125;,<br>&#125;<br><br><span class="hljs-type">void</span> mydevice_release(<span class="hljs-keyword">struct</span> device *dev)<br>&#123;<br>  printk(<span class="hljs-string">&quot;This is mydevice_release\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> platform_device platform_device_test = &#123;<br>  .name = <span class="hljs-string">&quot;mydevice&quot;</span>,<br>  .id = <span class="hljs-number">-1</span>,<br>  .resource = mydevice_resource,<br>  .num_resources = ARRAY_SIZE(mydevice_resource),<br>  .dev = &#123;<br>    .release = mydevice_release,<br>  &#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">platform_device_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  platform_device_register(&amp;platform_device_test);<br><br>  printk(<span class="hljs-string">&quot;platform_device init\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">platform_device_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  platform_device_unregister(&amp;platform_device_test);<br><br>  printk(<span class="hljs-string">&quot;platform_device exit\n&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>module <span class="hljs-title function_">init</span><span class="hljs-params">(platform_device_init)</span>;<br>module <span class="hljs-title function_">exit</span><span class="hljs-params">(platform_device_exit)</span>;<br><br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;goko&quot;</span>);<br>MODULE_VERSION(<span class="hljs-string">&quot;V1.0&quot;</span>);<br></code></pre></td></tr></table></figure>


<h4 id="3-platform-driver结构体"><a href="#3-platform-driver结构体" class="headerlink" title="3. platform_driver结构体"></a>3. platform_driver结构体</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> &#123;</span><br>	<span class="hljs-type">int</span> (*probe)(<span class="hljs-keyword">struct</span> platform_device *);     <span class="hljs-comment">// 匹配成功之后执行</span><br>	<span class="hljs-type">void</span> (*remove)(<span class="hljs-keyword">struct</span> platform_device *);   <span class="hljs-comment">// 设备移除时执行</span><br>	<span class="hljs-type">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> platform_device *); <span class="hljs-comment">// 设备关闭时执行dy</span><br>	<span class="hljs-type">int</span> (*suspend)(<span class="hljs-keyword">struct</span> platform_device *, <span class="hljs-type">pm_message_t</span> state); <span class="hljs-comment">// 设备挂起时执行dy</span><br>	<span class="hljs-type">int</span> (*resume)(<span class="hljs-keyword">struct</span> platform_device *);    <span class="hljs-comment">// 设备恢复时执行dy</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_driver</span> <span class="hljs-title">driver</span>;</span>                <span class="hljs-comment">// 设备公用的一些属性</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device_id</span> *<span class="hljs-title">id_table</span>;</span>  <span class="hljs-comment">// 设备id表</span><br>	<span class="hljs-type">bool</span> prevent_deferred_probe;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * For most device drivers, no need to care about this flag as long as</span><br><span class="hljs-comment">	 * all DMAs are handled through the kernel DMA API. For some special</span><br><span class="hljs-comment">	 * ones, for example VFIO drivers, they know how to manage the DMA</span><br><span class="hljs-comment">	 * themselves and set this flag so that the IOMMU layer will allow them</span><br><span class="hljs-comment">	 * to setup and manage their own I/O address space.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">bool</span> driver_managed_dma;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="4-简单的platform-driver"><a href="#4-简单的platform-driver" class="headerlink" title="4. 简单的platform_driver"></a>4. 简单的platform_driver</h4><ul>
<li>insmod注册成功：ls &#x2F;sys&#x2F;bus&#x2F;platform&#x2F;drivers&#x2F;mydevice</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span>      <span class="hljs-comment">// 所有模块都需要</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span>        <span class="hljs-comment">// __init 和 __exit 宏</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span>          <span class="hljs-comment">// file_operations 结构体和文件系统相关函数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span>        <span class="hljs-comment">// cdev 结构体和相关函数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span>     <span class="hljs-comment">// copy_to_user, copy_from_user</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span>      <span class="hljs-comment">// class_create, device_create</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/io.h&gt;</span>          <span class="hljs-comment">// ioremap, iounmap</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/platform_device.h&gt;</span> <span class="hljs-comment">// platform_driver 和 platform_device</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/of.h&gt;</span>          <span class="hljs-comment">// of_match_ptr, 设备树相关（如果使用设备树匹配）</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span>        <span class="hljs-comment">// kzalloc, kfree</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DRIVER_NAME <span class="hljs-string">&quot;my_platform_device&quot;</span> <span class="hljs-comment">// 定义驱动名称</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DEVICE_COUNT 1                   <span class="hljs-comment">// 定义设备数量</span></span><br><br><span class="hljs-comment">// 驱动的私有数据结构体，用于存储设备相关的所有信息</span><br><span class="hljs-comment">// 这个结构体整合了你截图中`struct device_test`的所有成员</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mydevice_dev</span> &#123;</span><br>    <span class="hljs-type">dev_t</span> dev_num;             <span class="hljs-comment">// 设备号 (主设备号 + 次设备号)</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cdev</span> <span class="hljs-title">cdev_test</span>;</span>     <span class="hljs-comment">// 字符设备结构体</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-keyword">class</span> *<span class="hljs-keyword">class</span>;</span>       <span class="hljs-comment">// 设备类，用于在/sys/class/下创建条目</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">device</span>;</span>     <span class="hljs-comment">// 设备实例，用于在/dev/下创建设备文件</span><br>    <span class="hljs-type">char</span> kbuf[<span class="hljs-number">32</span>];             <span class="hljs-comment">// 内核缓冲区，用于与用户空间交换数据</span><br>    <span class="hljs-type">void</span> __iomem *vir_gpio_dr;  <span class="hljs-comment">// 经过ioremap映射后的虚拟地址</span><br>&#125;;<br><br><span class="hljs-comment">// 全局指针，指向我们的私有数据结构体</span><br><span class="hljs-comment">// 在probe中分配，在remove中释放</span><br><span class="hljs-comment">// 注意：更好的做法是通过 platform_set_drvdata/platform_get_drvdata 来管理，这里为了清晰展示，先用一个全局指针</span><br><span class="hljs-comment">// 稍后会展示更标准的做法</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mydevice_dev</span> *<span class="hljs-title">global_mydev</span>;</span> <br><br><span class="hljs-comment">// --- 文件操作函数集 (file_operations) ---</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mydevice_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mydevice_dev</span> *<span class="hljs-title">dev</span>;</span><br><br>    printk(KERN_INFO <span class="hljs-string">&quot;mydevice: device opened\n&quot;</span>);<br><br>    <span class="hljs-comment">// 通过 inode 中的 cdev 指针，找到包含它的父结构体 mydevice_dev</span><br>    <span class="hljs-comment">// 这是内核中非常常见和重要的技巧</span><br>    dev = container_of(inode-&gt;i_cdev, <span class="hljs-keyword">struct</span> mydevice_dev, cdev_test);<br><br>    <span class="hljs-comment">// 将设备私有结构体的指针存放在 file-&gt;private_data 中</span><br>    <span class="hljs-comment">// 这样，在后续的 read/write/release 操作中，就可以直接从 file 中获取，无需再次查找</span><br>    file-&gt;private_data = dev; <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mydevice_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;mydevice: device closed\n&quot;</span>);<br>    <span class="hljs-comment">// 这里不需要释放 file-&gt;private_data，因为它指向的是在 probe 中分配的内存</span><br>    <span class="hljs-comment">// 该内存的生命周期与驱动绑定，而不是与文件的打开/关闭绑定</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mydevice_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> size, <span class="hljs-type">loff_t</span> *off)</span><br>&#123;<br>    <span class="hljs-comment">// 从 file-&gt;private_data 中获取设备私有结构体指针</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mydevice_dev</span> *<span class="hljs-title">dev</span> =</span> file-&gt;private_data;<br>    <span class="hljs-type">size_t</span> len = <span class="hljs-built_in">strlen</span>(dev-&gt;kbuf);<br>    <span class="hljs-type">int</span> ret;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;mydevice: reading data: %s\n&quot;</span>, dev-&gt;kbuf);<br><br>    <span class="hljs-keyword">if</span> (size &gt; len) &#123;<br>        size = len;<br>    &#125;<br><br>    <span class="hljs-comment">// 将内核空间的数据 (dev-&gt;kbuf) 拷贝到用户空间 (buf)</span><br>    ret = copy_to_user(buf, dev-&gt;kbuf, size);<br>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydevice: copy_to_user failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EFAULT; <span class="hljs-comment">// 返回一个标准的错误码</span><br>    &#125;<br><br>    <span class="hljs-comment">// 在这里，一个简单的实现是每次读取后返回已读取的字节数</span><br>    <span class="hljs-comment">// 一个更完整的实现需要处理 *off，以支持多次读取文件的不同部分</span><br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">mydevice_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> size, <span class="hljs-type">loff_t</span> *off)</span><br>&#123;<br>    <span class="hljs-comment">// 从 file-&gt;private_data 中获取设备私有结构体指针</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mydevice_dev</span> *<span class="hljs-title">dev</span> =</span> file-&gt;private_data;<br>    <span class="hljs-type">int</span> ret;<br><br>    <span class="hljs-keyword">if</span> (size &gt;= <span class="hljs-keyword">sizeof</span>(dev-&gt;kbuf)) &#123;<br>        printk(KERN_WARNING <span class="hljs-string">&quot;mydevice: write size is too large\n&quot;</span>);<br>        <span class="hljs-comment">// 截断写入的数据，防止缓冲区溢出</span><br>        size = <span class="hljs-keyword">sizeof</span>(dev-&gt;kbuf) - <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 将用户空间的数据 (buf) 拷贝到内核空间 (dev-&gt;kbuf)</span><br>    ret = copy_from_user(dev-&gt;kbuf, buf, size);<br>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydevice: copy_from_user failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EFAULT;<br>    &#125;<br><br>    <span class="hljs-comment">// 给内核缓冲区加上字符串结束符</span><br>    dev-&gt;kbuf[size] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;mydevice: written data: %s\n&quot;</span>, dev-&gt;kbuf);<br>    <br>    <span class="hljs-comment">// 在一个真实的GPIO驱动中，这里会解析 kbuf 中的命令（如&quot;on&quot;或&quot;off&quot;）</span><br>    <span class="hljs-comment">// 然后通过 dev-&gt;vir_gpio_dr 指针向硬件寄存器写入值</span><br>    <span class="hljs-comment">// 例如：iowrite32(1, dev-&gt;vir_gpio_dr);</span><br><br>    <span class="hljs-keyword">return</span> size; <span class="hljs-comment">// 返回成功写入的字节数</span><br>&#125;<br><br><span class="hljs-comment">// 定义 file_operations 结构体，并将我们的函数与之关联</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">mydevice_fops</span> =</span> &#123;<br>    .owner   = THIS_MODULE,<br>    .open    = mydevice_open,<br>    .release = mydevice_release,<br>    .read    = mydevice_read,<br>    .write   = mydevice_write,<br>&#125;;<br><br><br><span class="hljs-comment">// --- Platform 驱动核心函数 ---</span><br><br><span class="hljs-comment">// 当内核匹配到同名的 platform_device 时，会调用此 probe 函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mydriver_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *pdev)</span><br>&#123;<br>    <span class="hljs-type">int</span> ret;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">resource</span> *<span class="hljs-title">mem_res</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mydevice_dev</span> *<span class="hljs-title">dev</span>;</span><br><br>    printk(KERN_INFO <span class="hljs-string">&quot;mydriver_probe: device probed!\n&quot;</span>);<br><br>    <span class="hljs-comment">// 1. 分配私有数据结构体内存</span><br>    <span class="hljs-comment">// 使用 devm_kzalloc, &quot;devm_&quot; 开头的函数是受设备管理的，当设备卸载时会自动释放资源，非常方便</span><br>    dev = devm_kzalloc(&amp;pdev-&gt;dev, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> mydevice_dev), GFP_KERNEL);<br>    <span class="hljs-keyword">if</span> (!dev) &#123;<br>        <span class="hljs-keyword">return</span> -ENOMEM;<br>    &#125;<br>    global_mydev = dev; <span class="hljs-comment">// 赋值给全局指针（仅为示例）</span><br><br>    <span class="hljs-comment">// 2. 从 platform_device 获取资源 (这里以内存资源为例)</span><br>    <span class="hljs-comment">// 参数: platform_device指针, 资源类型, 索引(第0个内存资源)</span><br>    mem_res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!mem_res) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydriver: failed to get memory resource\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br>    printk(KERN_INFO <span class="hljs-string">&quot;mydriver: mem resource start: 0x%pa, size: %lld\n&quot;</span>, &amp;mem_res-&gt;start, resource_size(mem_res));<br>    <br>    <span class="hljs-comment">// 3. 将物理地址映射到内核虚拟地址空间</span><br>    <span class="hljs-comment">// devm_ioremap_resource 会自动处理 ioremap 和 iounmap，非常推荐使用</span><br>    dev-&gt;vir_gpio_dr = devm_ioremap_resource(&amp;pdev-&gt;dev, mem_res);<br>    <span class="hljs-keyword">if</span> (IS_ERR(dev-&gt;vir_gpio_dr)) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydriver: failed to ioremap memory resource\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> PTR_ERR(dev-&gt;vir_gpio_dr);<br>    &#125;<br>    <br>    <span class="hljs-comment">// ======== 以下是字符设备创建的标准流程 (来自你的截图逻辑) ========</span><br><br>    <span class="hljs-comment">// 4. 动态申请设备号</span><br>    ret = alloc_chrdev_region(&amp;dev-&gt;dev_num, <span class="hljs-number">0</span>, DEVICE_COUNT, DRIVER_NAME);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydriver: failed to allocate chrdev region\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br>    printk(KERN_INFO <span class="hljs-string">&quot;mydriver: allocated major=%d, minor=%d\n&quot;</span>, MAJOR(dev-&gt;dev_num), MINOR(dev-&gt;dev_num));<br><br>    <span class="hljs-comment">// 5. 初始化 cdev 结构体，并绑定 file_operations</span><br>    cdev_init(&amp;dev-&gt;cdev_test, &amp;mydevice_fops);<br>    dev-&gt;cdev_test.owner = THIS_MODULE;<br><br>    <span class="hljs-comment">// 6. 将 cdev 添加到内核中</span><br>    ret = cdev_add(&amp;dev-&gt;cdev_test, dev-&gt;dev_num, DEVICE_COUNT);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydriver: failed to add cdev\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_unregister_chrdev;<br>    &#125;<br><br>    <span class="hljs-comment">// 7. 创建设备类 /sys/class/my_platform_device</span><br>    dev-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span> =</span> class_create(THIS_MODULE, DRIVER_NAME);<br>    <span class="hljs-keyword">if</span> (IS_ERR(dev-&gt;class)) &#123;<br>        ret = PTR_ERR(dev-&gt;class);<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydriver: failed to create class\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_cdev_del;<br>    &#125;<br><br>    <span class="hljs-comment">// 8. 创建设备文件 /dev/my_platform_device</span><br>    dev-&gt;device = device_create(dev-&gt;class, <span class="hljs-literal">NULL</span>, dev-&gt;dev_num, <span class="hljs-literal">NULL</span>, DRIVER_NAME);<br>    <span class="hljs-keyword">if</span> (IS_ERR(dev-&gt;device)) &#123;<br>        ret = PTR_ERR(dev-&gt;device);<br>        printk(KERN_ERR <span class="hljs-string">&quot;mydriver: failed to create device\n&quot;</span>);<br>        <span class="hljs-keyword">goto</span> err_class_destroy;<br>    &#125;<br><br>    <span class="hljs-comment">// 9. 将私有数据结构体指针与 platform_device 关联</span><br>    <span class="hljs-comment">// 这样在 remove 函数中就可以通过 platform_get_drvdata 获取它</span><br>    platform_set_drvdata(pdev, dev);<br><br>    <span class="hljs-comment">// 初始化内核缓冲区</span><br>    <span class="hljs-built_in">strcpy</span>(dev-&gt;kbuf, <span class="hljs-string">&quot;Hello from kernel!&quot;</span>);<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;mydriver: probe successful, device created at /dev/%s\n&quot;</span>, DRIVER_NAME);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// 错误处理：按相反的顺序释放已申请的资源</span><br>err_class_destroy:<br>    class_destroy(dev-&gt;class);<br>err_cdev_del:<br>    cdev_del(&amp;dev-&gt;cdev_test);<br>err_unregister_chrdev:<br>    unregister_chrdev_region(dev-&gt;dev_num, DEVICE_COUNT);<br>    <span class="hljs-comment">// devm_kzalloc 和 devm_ioremap_resource 分配的资源会自动释放，无需手动处理</span><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">// 当驱动被卸载或设备被移除时，调用此 remove 函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mydriver_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> platform_device *pdev)</span><br>&#123;<br>    <span class="hljs-comment">// 通过 platform_get_drvdata 获取在 probe 中设置的私有数据</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mydevice_dev</span> *<span class="hljs-title">dev</span> =</span> platform_get_drvdata(pdev);<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;mydriver_remove: removing device\n&quot;</span>);<br><br>    <span class="hljs-comment">// 按照与 probe 相反的顺序销毁和释放资源</span><br>    <span class="hljs-comment">// 注意：devm_ 家族函数管理的资源（内存、ioremap）不需要在这里手动释放！</span><br>    <span class="hljs-comment">// 驱动核心会在这个函数返回后自动清理它们。</span><br><br>    <span class="hljs-comment">// 销毁设备文件 /dev/my_platform_device</span><br>    device_destroy(dev-&gt;class, dev-&gt;dev_num);<br>    <span class="hljs-comment">// 销毁设备类 /sys/class/my_platform_device</span><br>    class_destroy(dev-&gt;class);<br>    <span class="hljs-comment">// 从内核中删除 cdev</span><br>    cdev_del(&amp;dev-&gt;cdev_test);<br>    <span class="hljs-comment">// 注销设备号</span><br>    unregister_chrdev_region(dev-&gt;dev_num, DEVICE_COUNT);<br><br>    printk(KERN_INFO <span class="hljs-string">&quot;mydriver_remove: remove successful\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// ID 表，用于匹配 platform_device</span><br><span class="hljs-comment">// 当一个 platform_device 的 .name 字段与这里的 .name 匹配时，probe 就会被调用</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device_id</span> <span class="hljs-title">mydriver_id_table</span>[] =</span> &#123;<br>    &#123; .name = <span class="hljs-string">&quot;my-platform-device-example&quot;</span> &#125;, <span class="hljs-comment">// 这个名字需要与 platform_device 注册时使用的名字完全一致</span><br>    &#123; <span class="hljs-comment">/* sentinel */</span> &#125;, <span class="hljs-comment">// 结尾的空条目，表示列表结束</span><br>&#125;;<br>MODULE_DEVICE_TABLE(platform, mydriver_id_table); <span class="hljs-comment">// 将id_table导出，让内核和用户空间知道</span><br><br><span class="hljs-comment">// 定义 platform_driver 结构体</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> <span class="hljs-title">my_platform_driver</span> =</span> &#123;<br>    .probe  = mydriver_probe,<br>    .remove = mydriver_remove,<br>    .driver = &#123;<br>        .name  = <span class="hljs-string">&quot;my-platform-device-example&quot;</span>, <span class="hljs-comment">// 驱动的名字</span><br>        .owner = THIS_MODULE,<br>    &#125;,<br>    .id_table = mydriver_id_table, <span class="hljs-comment">// 关联ID匹配表</span><br>&#125;;<br><br><span class="hljs-comment">// 模块加载函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">my_driver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;my_driver_init: Registering platform driver\n&quot;</span>);<br>    <span class="hljs-comment">// 注册 platform_driver 到内核</span><br>    <span class="hljs-keyword">return</span> platform_driver_register(&amp;my_platform_driver);<br>&#125;<br><br><span class="hljs-comment">// 模块卸载函数</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">my_driver_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    printk(KERN_INFO <span class="hljs-string">&quot;my_driver_exit: Unregistering platform driver\n&quot;</span>);<br>    <span class="hljs-comment">// 从内核中注销 platform_driver</span><br>    platform_driver_unregister(&amp;my_platform_driver);<br>&#125;<br><br><span class="hljs-comment">// 注册模块加载和卸载函数</span><br>module_init(my_driver_init);<br>module_exit(my_driver_exit);<br><br><span class="hljs-comment">// 模块许可和信息</span><br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br>MODULE_AUTHOR(<span class="hljs-string">&quot;Your Name&quot;</span>);<br>MODULE_DESCRIPTION(<span class="hljs-string">&quot;A complete platform device driver example&quot;</span>);<br>MODULE_VERSION(<span class="hljs-string">&quot;1.0&quot;</span>);<br></code></pre></td></tr></table></figure>


<h3 id="平台总线和设备驱动"><a href="#平台总线和设备驱动" class="headerlink" title="平台总线和设备驱动"></a>平台总线和设备驱动</h3><ol>
<li><p><strong>启动与准备 (第 0 步):</strong></p>
<ul>
<li>内核启动，解析设备树。</li>
<li>它看到一个描述 I2C 控制器的节点，于是创建了一个 <code>platform_device</code>。</li>
<li>它看到 I2C 控制器节点下还有一个描述温度传感器的子节点，于是为它创建了一个 <code>i2c_client</code> 的描述信息（但此时还未注册，因为 I2C 总线还不存在）。</li>
</ul>
</li>
<li><p><strong>第一层匹配 (平台总线):</strong></p>
<ul>
<li>你加载了 <strong>I2C 控制器驱动</strong> (<code>platform_driver</code>)。</li>
<li><strong>平台总线</strong>发现这个驱动和之前创建的 <code>platform_device</code> 匹配。</li>
<li>平台总线调用 <strong>I2C 控制器驱动</strong> 的 <code>.probe()</code> 函数。</li>
</ul>
</li>
<li><p><strong>桥梁搭建 (控制器驱动的工作):</strong></p>
<ul>
<li>在 <strong>I2C 控制器驱动</strong> 的 <code>.probe()</code> 函数中，驱动初始化了硬件，然后调用 <code>i2c_add_adapter()</code>。</li>
<li><strong>这个调用是关键！</strong> 它在内核里创建并注册了一条功能完备的 <strong>I2C 总线</strong>。</li>
</ul>
</li>
<li><p><strong>第二层匹配 (I2C 总线):</strong></p>
<ul>
<li>新的 I2C 总线被注册后，内核的 I2C 核心会把之前为温度传感器准备的 <code>i2c_client</code> 描述信息，正式注册到这条新的 I2C 总线上。</li>
<li>现在，你加载了<strong>温度传感器驱动</strong> (<code>i2c_driver</code>)。</li>
<li><strong>I2C 总线</strong>发现这个驱动和刚刚注册的 <code>i2c_client</code> 匹配。</li>
<li>I2C 总线调用<strong>温度传感器驱动</strong>的 <code>.probe()</code> 函数。</li>
</ul>
</li>
<li><p><strong>最终通信 (设备驱动的工作):</strong></p>
<ul>
<li>在<strong>温度传感器驱动</strong>的 <code>.probe()</code> 或其他函数里，它想读取温度。</li>
<li>它调用一个标准的、与硬件无关的函数 <code>i2c_master_recv()</code>。</li>
<li>I2C 核心收到调用，查找该设备挂在哪条 I2C 总线上。</li>
<li>它找到了由<strong>I2C 控制器驱动</strong>注册的那条总线，然后调用了<strong>该控制器驱动</strong>提供的底层传输函数。</li>
<li><strong>I2C 控制器驱动</strong>的代码开始执行，通过操作寄存器来命令<strong>物理 I2C 控制器</strong>去和<strong>物理温度传感器</strong>通信，并取回数据。</li>
</ul>
</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>平台总线的结构及框架分析</p><p><a href="https://goko-son626.github.io/post/Platform-bus.html">https://goko-son626.github.io/post/Platform-bus.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><a href="https://GoKo-Son626.github.io"><p>GoKo Mell</p></a></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-06-07</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-09-11</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/zfb.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/vx.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/post/u-boot.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">U-boot 移植及源码分析( ARM )</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/post/the-Three-Basic-Linux-Driver-Models.html"><span class="level-item">三种常见的 linux 设备的驱动介绍及框架</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">评论</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '179c676dd225a2fb62138ab93888e379',
            repo: 'blog_comment',
            owner: 'GoKo-Son626',
            clientID: 'Ov23liQkUSIVMH77fBvF',
            clientSecret: '7944864208d7577569d1f323e727967d4bdc5e79',
            admin: ["Goko-Son626"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/logo.png" alt="GoKo Mell"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">GoKo Mell</p><p class="is-size-6 is-block">尚未执佩剑，转眼即江湖</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives/"><p class="title">13</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories/"><p class="title">19</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags/"><p class="title">12</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/GoKo-Son626" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/GoKo-Son626"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:goku.sonxin626@gmail.com"><i class="fa fa-envelope"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"来源《"+data.from+"》</p><p>提供者-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-07-31T18:36:11.000Z">2025-08-01</time></p><p class="title"><a href="/post/use-bpftrace-on-k1.html">bpftrace环境的配置和使用(基于riscv-k1)</a></p><p class="categories"><a href="/categories/linux/">linux</a> / <a href="/categories/linux/kernel/">kernel</a> / <a href="/categories/linux/kernel/trace/">trace</a> / <a href="/categories/linux/kernel/trace/bpftrace/">bpftrace</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-30T15:42:34.000Z">2025-04-30</time></p><p class="title"><a href="/post/ebpf-and-use-libbpf.html">Linux bpf技术解析及libbpf的使用(基于riscv-k1)</a></p><p class="categories"><a href="/categories/linux/">linux</a> / <a href="/categories/linux/kernel/">kernel</a> / <a href="/categories/linux/kernel/trace/">trace</a> / <a href="/categories/linux/kernel/trace/libbpf/">libbpf</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-03T01:25:24.000Z">2025-04-03</time></p><p class="title"><a href="/post/qspinlock.html">linux内核中qspinlock锁的优缺点分析</a></p><p class="categories"><a href="/categories/linux/">linux</a> / <a href="/categories/linux/kernel/">kernel</a> / <a href="/categories/linux/kernel/lock/">lock</a> / <a href="/categories/linux/kernel/lock/qspinlock/">qspinlock</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-02T08:40:24.000Z">2025-03-02</time></p><p class="title"><a href="/post/libbpf-bcc-and-bpftrace.html">libbpf, bcc和bpftrace的结构和关联分析</a></p><p class="categories"><a href="/categories/linux/">linux</a> / <a href="/categories/linux/kernel/">kernel</a> / <a href="/categories/linux/kernel/trace/">trace</a> / <a href="/categories/linux/kernel/trace/ebpf/">ebpf</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-12T14:20:39.000Z">2024-10-12</time></p><p class="title"><a href="/post/kernel-1.html">linux内核启动流程分析2</a></p><p class="categories"><a href="/categories/linux/">linux</a> / <a href="/categories/linux/kernel/">kernel</a> / <a href="/categories/linux/kernel/kernel-start/">kernel_start</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/linux/"><span class="level-start"><span class="level-item">linux</span></span><span class="level-end"><span class="level-item tag">10</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/"><span class="level-start"><span class="level-item">kernel</span></span><span class="level-end"><span class="level-item tag">8</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/driver/"><span class="level-start"><span class="level-item">driver</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/driver/platform-bus/"><span class="level-start"><span class="level-item">platform_bus</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/driver/three-driver-struct/"><span class="level-start"><span class="level-item">three_driver_struct</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/kernel-start/"><span class="level-start"><span class="level-item">kernel_start</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/lock/"><span class="level-start"><span class="level-item">lock</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/lock/qspinlock/"><span class="level-start"><span class="level-item">qspinlock</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/trace/"><span class="level-start"><span class="level-item">trace</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/linux/kernel/trace/bpftrace/"><span class="level-start"><span class="level-item">bpftrace</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li></ul></li></ul></li><a class="level is-mobile is-marginless" href="/categories/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2025/08/"><span class="level-start"><span class="level-item">八月 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/04/"><span class="level-start"><span class="level-item">四月 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2025/03/"><span class="level-start"><span class="level-item">三月 2025</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/10/"><span class="level-start"><span class="level-item">十月 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2024/09/"><span class="level-start"><span class="level-item">九月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/bpftrace/"><span class="tag">bpftrace</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kernel-start/"><span class="tag">kernel_start</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/libbpf/"><span class="tag">libbpf</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bcc/"><span class="tag">bcc</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/compiler/"><span class="tag">compiler</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/driver-struct/"><span class="tag">driver_struct</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/platform-bus/"><span class="tag">platform_bus</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/qspinlock/"><span class="tag">qspinlock</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/toolchain/"><span class="tag">toolchain</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uboot-cmd/"><span class="tag">uboot_cmd</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uboot-start/"><span class="tag">uboot_start</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/GoKo-Mell.png" alt="GoKo&#039;s blog" height="28"></a><p class="size-small"><span>&copy; 2025 GoKo Mell</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="mailto:goku.sonxin626@gmail.com">联系我</a>，立即处理]<br /></span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.10.0/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('Ov23liQkUSIVMH77fBvF','7944864208d7577569d1f323e727967d4bdc5e79','GoKo-Son626','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>